<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Résultats UVSQ - Plateforme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        .table-row:hover {
            background-color: #f8fafc;
        }
        .upload-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.drag-over {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sort-icon {
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .sort-icon.active {
            opacity: 1;
        }
        th:hover .sort-icon {
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-8 shadow-lg">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-center">Résultats Universitaires</h1>
            <p class="text-center mt-2 text-purple-100">Plateforme de visualisation des notes</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Upload Section -->
        <div class="bg-white rounded-2xl card-shadow p-8 mb-8 fade-in">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Importer un fichier Excel</h2>
            <div id="uploadZone" class="upload-zone rounded-xl p-8 text-center cursor-pointer">
                <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <p class="text-gray-600 mb-2">Glissez-déposez votre fichier Excel ici</p>
                <p class="text-sm text-gray-400">ou cliquez pour sélectionner</p>
                <p id="fileName" class="mt-4 text-purple-600 font-medium hidden"></p>
            </div>
            <div id="uploadProgress" class="hidden mt-4">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div id="filtersSection" class="bg-white rounded-2xl card-shadow p-6 mb-8 hidden fade-in">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Filtres</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                    <input type="text" id="filterNom" placeholder="Rechercher par nom..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prénom</label>
                    <input type="text" id="filterPrenom" placeholder="Rechercher par prénom..."
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Note minimum</label>
                    <input type="number" id="filterNoteMin" placeholder="0" min="0" max="20" step="0.1"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Note maximum</label>
                    <input type="number" id="filterNoteMax" placeholder="20" min="0" max="20" step="0.1"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition">
                </div>
            </div>
            <div class="mt-4 flex gap-4">
                <button id="applyFilters" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                    Appliquer les filtres
                </button>
                <button id="resetFilters" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
                    Réinitialiser
                </button>
            </div>
        </div>

        <!-- Stats Section -->
        <div id="statsSection" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 hidden">
            <div class="bg-white rounded-xl card-shadow p-6 fade-in">
                <p class="text-sm text-gray-500 uppercase tracking-wide">Total étudiants</p>
                <p id="statTotal" class="text-3xl font-bold text-gray-800 mt-2">0</p>
            </div>
            <div class="bg-white rounded-xl card-shadow p-6 fade-in">
                <p class="text-sm text-gray-500 uppercase tracking-wide">Moyenne générale</p>
                <p id="statMoyenne" class="text-3xl font-bold text-purple-600 mt-2">--</p>
            </div>
            <div class="bg-white rounded-xl card-shadow p-6 fade-in">
                <p class="text-sm text-gray-500 uppercase tracking-wide">Note max</p>
                <p id="statMax" class="text-3xl font-bold text-green-600 mt-2">--</p>
            </div>
            <div class="bg-white rounded-xl card-shadow p-6 fade-in">
                <p class="text-sm text-gray-500 uppercase tracking-wide">Note min</p>
                <p id="statMin" class="text-3xl font-bold text-red-500 mt-2">--</p>
            </div>
        </div>

        <!-- Results Table -->
        <div id="resultsSection" class="bg-white rounded-2xl card-shadow overflow-hidden hidden fade-in">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-800">Résultats</h2>
                <span id="resultCount" class="text-sm text-gray-500"></span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="nom">
                                Nom <span class="sort-icon">↕</span>
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="prenom">
                                Prénom <span class="sort-icon">↕</span>
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="ue1_num">
                                <span id="colUe1Label">UE 1</span> <span class="sort-icon">↕</span>
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="ue2_num">
                                <span id="colUe2Label">UE 2</span> <span class="sort-icon">↕</span>
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="ue3_num">
                                <span id="colUe3Label">UE 3</span> <span class="sort-icon">↕</span>
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="ue4_num">
                                <span id="colUe4Label">UE 4</span> <span class="sort-icon">↕</span>
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="moyenne">
                                Moyenne <span class="sort-icon">↕</span>
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Rang
                            </th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-16">
            <svg class="mx-auto h-24 w-24 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p class="mt-4 text-gray-500 text-lg">Importez un fichier Excel pour afficher les résultats</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>Plateforme de gestion des résultats universitaires</p>
        </div>
    </footer>

    <script>
        let allData = [];
        let filteredData = [];
        let currentSort = { column: 'moyenne', direction: 'asc' };
        // Libellés dynamiques des colonnes de notes (adaptés au fichier Excel)
        let gradeLabels = ['UE 1', 'UE 2', 'UE 3', 'UE 4'];

        // DOM Elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const filtersSection = document.getElementById('filtersSection');
        const statsSection = document.getElementById('statsSection');
        const resultsSection = document.getElementById('resultsSection');
        const emptyState = document.getElementById('emptyState');
        const resultsBody = document.getElementById('resultsBody');

        // Upload handling
        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function parseNote(value) {
            if (value === null || value === undefined || value === '') return null;
            const str = String(value).trim().replace(',', '.').replace(' ', '');
            const num = parseFloat(str);
            return isNaN(num) ? null : num;
        }

        function normalizeHeader(value) {
            if (!value) return '';
            return String(value)
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // enlever les accents
                .replace(/[^a-z0-9]/g, ''); // enlever espaces, ponctuation, etc.
        }

        function findColumnIndex(columns, searchTerms) {
            for (let i = 0; i < columns.length; i++) {
                const col = normalizeHeader(columns[i]);
                for (const term of searchTerms) {
                    const normTerm = normalizeHeader(term);
                    if (col.includes(normTerm)) {
                        return i;
                    }
                }
            }
            return -1;
        }

        // Détecter automatiquement les colonnes de notes (0-20) même si les noms changent
        function detectNumericColumns(headers, dataRows, excludedIndices = new Set()) {
            const scores = new Map();

            for (let colIdx = 0; colIdx < headers.length; colIdx++) {
                if (excludedIndices.has(colIdx)) continue;

                let numericCount = 0;
                let totalCount = 0;

                for (const row of dataRows) {
                    if (!row || row.length <= colIdx) continue;
                    const value = row[colIdx];
                    if (value === null || value === undefined || value === '') continue;
                    totalCount++;

                    const num = parseNote(value);
                    if (num !== null && num >= 0 && num <= 20) {
                        numericCount++;
                    }
                }

                if (totalCount > 0 && numericCount > 0) {
                    const ratio = numericCount / totalCount;
                    // On garde les colonnes où au moins 30% des valeurs ressemblent à des notes
                    if (ratio >= 0.3) {
                        scores.set(colIdx, numericCount);
                    }
                }
            }

            // Trier par nombre de valeurs numériques décroissant
            return Array.from(scores.entries())
                .sort((a, b) => b[1] - a[1])
                .map(([idx]) => idx);
        }

        function processExcelData(workbook) {
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null });

            if (jsonData.length === 0) {
                throw new Error('Le fichier Excel est vide');
            }

            // Première ligne = en-têtes
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1);

            // Trouver les indices des colonnes de base (nom, prénom, rang)
            const nomIdx = findColumnIndex(headers, ['nom', 'name']);
            const prenomIdx = findColumnIndex(headers, ['prénom', 'prenom', 'prename', 'first']);
            const rangIdx = findColumnIndex(headers, ['rang', 'rank', 'classement', 'position']);

            // Détecter automatiquement les colonnes de notes (0-20)
            const excluded = new Set();
            if (nomIdx >= 0) excluded.add(nomIdx);
            if (prenomIdx >= 0) excluded.add(prenomIdx);
            if (rangIdx >= 0) excluded.add(rangIdx);

            const numericCols = detectNumericColumns(headers, dataRows, excluded);
            // On garde au maximum 4 colonnes de notes
            const gradeIdxs = numericCols.slice(0, 4);

            // Mettre à jour les libellés affichés dans le tableau en fonction des noms de colonnes du fichier
            gradeLabels = gradeIdxs.map((idx, i) => {
                const header = headers[idx];
                if (header && String(header).trim() !== '') {
                    return String(header);
                }
                return `Note ${i + 1}`;
            });
            // Compléter à 4 entrées pour éviter les erreurs d'index
            while (gradeLabels.length < 4) {
                gradeLabels.push(`Note ${gradeLabels.length + 1}`);
            }

            const processedData = [];

            dataRows.forEach(row => {
                if (!row || row.length === 0) return;

                const nom = nomIdx >= 0 ? row[nomIdx] : null;
                const prenom = prenomIdx >= 0 ? row[prenomIdx] : null;
                const rang = rangIdx >= 0 ? row[rangIdx] : null;

                // Récupérer les valeurs de notes en fonction des colonnes détectées
                const gradeValues = gradeIdxs.map(idx => (idx >= 0 && row.length > idx ? row[idx] : null));
                const gradeNums = gradeValues.map(v => parseNote(v));

                const ue1 = gradeValues[0] ?? null;
                const ue2 = gradeValues[1] ?? null;
                const ue3 = gradeValues[2] ?? null;
                const ue4 = gradeValues[3] ?? null;

                const ue1_num = gradeNums[0] ?? null;
                const ue2_num = gradeNums[1] ?? null;
                const ue3_num = gradeNums[2] ?? null;
                const ue4_num = gradeNums[3] ?? null;

                // Calculer la moyenne
                const notes = gradeNums.filter(n => n !== null);
                const moyenne = notes.length > 0 ? notes.reduce((a, b) => a + b, 0) / notes.length : null;

                processedData.push({
                    nom: nom || null,
                    prenom: prenom || null,
                    ue1: ue1,
                    ue2: ue2,
                    ue3: ue3,
                    ue4: ue4,
                    ue1_num: ue1_num,
                    ue2_num: ue2_num,
                    ue3_num: ue3_num,
                    ue4_num: ue4_num,
                    moyenne: moyenne,
                    rang: rang || null
                });
            });

            return processedData;
        }

        function updateGradeHeaders() {
            const ids = ['colUe1Label', 'colUe2Label', 'colUe3Label', 'colUe4Label'];
            ids.forEach((id, index) => {
                const el = document.getElementById(id);
                if (!el) return;
                const label = gradeLabels[index];
                el.textContent = label || `Note ${index + 1}`;
            });
        }

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                alert('Veuillez sélectionner un fichier Excel (.xlsx ou .xls)');
                return;
            }

            fileName.textContent = file.name;
            fileName.classList.remove('hidden');

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const processedData = processExcelData(workbook);

                    if (processedData.length === 0) {
                        alert('Aucune donnée trouvée dans le fichier Excel');
                        return;
                    }

                    allData = processedData;
                    filteredData = [...allData];
                    updateGradeHeaders();
                    sortData();
                    displayResults();
                    showSections();
                    updateStats();
                } catch (error) {
                    alert('Erreur lors du traitement du fichier: ' + error.message);
                    console.error(error);
                }
            };

            reader.onerror = function() {
                alert('Erreur lors de la lecture du fichier');
            };

            reader.readAsArrayBuffer(file);
        }

        function showSections() {
            emptyState.classList.add('hidden');
            filtersSection.classList.remove('hidden');
            statsSection.classList.remove('hidden');
            resultsSection.classList.remove('hidden');
        }

        function formatNote(value) {
            if (value === null || value === undefined || value === '') return '--';
            const num = parseFloat(String(value).replace(',', '.'));
            if (isNaN(num)) return value;
            return num.toFixed(2);
        }

        function getNoteClass(value) {
            if (value === null || value === undefined) return 'text-gray-400';
            const num = parseFloat(String(value).replace(',', '.'));
            if (isNaN(num)) return 'text-gray-400';
            if (num >= 14) return 'text-green-600 font-semibold';
            if (num >= 10) return 'text-blue-600';
            return 'text-red-500';
        }

        function displayResults() {
            resultsBody.innerHTML = '';
            document.getElementById('resultCount').textContent = `${filteredData.length} résultat(s)`;

            filteredData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = 'table-row transition';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${row.nom || '--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${row.prenom || '--'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center ${getNoteClass(row.ue1_num)}">${formatNote(row.ue1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center ${getNoteClass(row.ue2_num)}">${formatNote(row.ue2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center ${getNoteClass(row.ue3_num)}">${formatNote(row.ue3)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center ${getNoteClass(row.ue4_num)}">${formatNote(row.ue4)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center font-bold ${getNoteClass(row.moyenne)}">${formatNote(row.moyenne)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-gray-600">${row.rang || '--'}</td>
                `;
                resultsBody.appendChild(tr);
            });
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = filteredData.length;

            const moyennes = filteredData.map(r => r.moyenne).filter(m => m !== null && !isNaN(m));

            if (moyennes.length > 0) {
                const avg = moyennes.reduce((a, b) => a + b, 0) / moyennes.length;
                document.getElementById('statMoyenne').textContent = avg.toFixed(2);
                document.getElementById('statMax').textContent = Math.max(...moyennes).toFixed(2);
                document.getElementById('statMin').textContent = Math.min(...moyennes).toFixed(2);
            } else {
                document.getElementById('statMoyenne').textContent = '--';
                document.getElementById('statMax').textContent = '--';
                document.getElementById('statMin').textContent = '--';
            }
        }

        // Sorting
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;

                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }

                // Update sort icons
                document.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.classList.remove('active');
                    icon.textContent = '↕';
                });
                const activeIcon = th.querySelector('.sort-icon');
                activeIcon.classList.add('active');
                activeIcon.textContent = currentSort.direction === 'asc' ? '↑' : '↓';

                sortData();
                displayResults();
            });
        });

        function sortData() {
            const { column, direction } = currentSort;

            filteredData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // Handle null values
                if (valA === null || valA === undefined) return 1;
                if (valB === null || valB === undefined) return -1;

                // String comparison for nom/prenom
                if (column === 'nom' || column === 'prenom') {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    if (direction === 'asc') {
                        return valA.localeCompare(valB, 'fr');
                    }
                    return valB.localeCompare(valA, 'fr');
                }

                // Numeric comparison
                if (direction === 'asc') {
                    return valA - valB;
                }
                return valB - valA;
            });
        }

        // Filtering
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);

        // Real-time filtering
        ['filterNom', 'filterPrenom', 'filterNoteMin', 'filterNoteMax'].forEach(id => {
            document.getElementById(id).addEventListener('input', applyFilters);
        });

        function applyFilters() {
            const nom = document.getElementById('filterNom').value.toLowerCase();
            const prenom = document.getElementById('filterPrenom').value.toLowerCase();
            const noteMin = parseFloat(document.getElementById('filterNoteMin').value) || 0;
            const noteMax = parseFloat(document.getElementById('filterNoteMax').value) || 20;

            filteredData = allData.filter(row => {
                const matchNom = !nom || (row.nom && row.nom.toLowerCase().includes(nom));
                const matchPrenom = !prenom || (row.prenom && row.prenom.toLowerCase().includes(prenom));

                let matchNote = true;
                if (row.moyenne !== null && !isNaN(row.moyenne)) {
                    matchNote = row.moyenne >= noteMin && row.moyenne <= noteMax;
                }

                return matchNom && matchPrenom && matchNote;
            });

            sortData();
            displayResults();
            updateStats();
        }

        function resetFilters() {
            document.getElementById('filterNom').value = '';
            document.getElementById('filterPrenom').value = '';
            document.getElementById('filterNoteMin').value = '';
            document.getElementById('filterNoteMax').value = '';

            filteredData = [...allData];
            sortData();
            displayResults();
            updateStats();
        }
    </script>
</body>
</html>
